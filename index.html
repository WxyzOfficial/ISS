<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>IT Survival Simulator - Philippine IT Skills Training</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #1e3c72, #2a5298);
            color: #ffffff;
            line-height: 1.6;
            min-height: 100vh;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        
        .header {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            padding: 1rem 0;
            margin-bottom: 2rem;
            border-radius: 15px;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        
        .header h1 {
            text-align: center;
            font-size: 2.5rem;
            font-weight: 700;
            background: linear-gradient(45deg, #ffd700, #ffed4e);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        
        .header .tagline {
            text-align: center;
            margin-top: 0.5rem;
            opacity: 0.9;
            font-size: 1.1rem;
        }
        
        .card {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 2rem;
            margin-bottom: 2rem;
            border: 1px solid rgba(255, 255, 255, 0.2);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }
        
        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3);
        }
        
        .btn {
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1rem;
            font-weight: 600;
            transition: all 0.3s ease;
            text-decoration: none;
            display: inline-block;
            text-align: center;
        }
        
        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.3);
        }
        
        .btn-primary {
            background: linear-gradient(45deg, #f093fb, #f5576c);
        }
        
        .btn-success {
            background: linear-gradient(45deg, #4facfe, #00f2fe);
        }
        
        .btn-danger {
            background: linear-gradient(45deg, #fa709a, #fee140);
        }
        
        .input-group {
            margin-bottom: 1rem;
        }
        
        .input-group label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 600;
        }
        
        .input-group input,
        .input-group textarea,
        .input-group select {
            width: 100%;
            padding: 12px;
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-radius: 8px;
            background: rgba(255, 255, 255, 0.1);
            color: white;
            font-size: 1rem;
        }
        
        .input-group input::placeholder,
        .input-group textarea::placeholder {
            color: rgba(255, 255, 255, 0.6);
        }
        
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(5px);
        }
        
        .modal-content {
            background: linear-gradient(135deg, #667eea, #764ba2);
            margin: 5% auto;
            padding: 2rem;
            border-radius: 15px;
            width: 90%;
            max-width: 600px;
            max-height: 80vh;
            overflow-y: auto;
            border: 1px solid rgba(255, 255, 255, 0.3);
        }
        
        .close {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
        }
        
        .close:hover {
            color: white;
        }
        
        .dashboard {
            display: grid;
            grid-template-columns: 1fr 300px;
            gap: 2rem;
        }
        
        @media (max-width: 768px) {
            .dashboard {
                grid-template-columns: 1fr;
            }
            
            .header h1 {
                font-size: 1.8rem;
            }
        }
        
        .tasks-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 1rem;
        }
        
        .task-card {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            padding: 1.5rem;
            border: 1px solid rgba(255, 255, 255, 0.2);
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .task-card:hover {
            background: rgba(255, 255, 255, 0.2);
            transform: translateY(-3px);
        }
        
        .difficulty {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: bold;
        }
        
        .difficulty-1 { background: #4CAF50; }
        .difficulty-2 { background: #8BC34A; }
        .difficulty-3 { background: #FFC107; }
        .difficulty-4 { background: #FF9800; }
        .difficulty-5 { background: #F44336; }
        
        .category {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 15px;
            font-size: 0.9rem;
            font-weight: 500;
            margin-right: 10px;
        }
        
        .category-helpdesk { background: #3F51B5; }
        .category-webdev { background: #009688; }
        .category-debugging { background: #FF5722; }
        .category-networking { background: #607D8B; }
        .category-database { background: #795548; }
        .category-security { background: #E91E63; }
        .category-devops { background: #2196F3; }
        .category-legacy { background: #9C27B0; }
        
        .timer {
            font-size: 1.5rem;
            font-weight: bold;
            text-align: center;
            margin: 1rem 0;
            padding: 1rem;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
        }
        
        .penalty-warning {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: linear-gradient(45deg, #ff6b6b, #feca57);
            color: white;
            padding: 2rem;
            border-radius: 15px;
            text-align: center;
            z-index: 2000;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.5);
            animation: shake 0.5s ease-in-out;
        }
        
        @keyframes shake {
            0%, 100% { transform: translate(-50%, -50%) rotate(0deg); }
            25% { transform: translate(-50%, -50%) rotate(5deg); }
            75% { transform: translate(-50%, -50%) rotate(-5deg); }
        }
        
        .code-editor {
            width: 100%;
            min-height: 200px;
            background: #1e1e1e;
            color: #d4d4d4;
            border: 1px solid #404040;
            border-radius: 8px;
            padding: 1rem;
            font-family: 'Consolas', 'Monaco', 'Courier New', monospace;
            font-size: 14px;
            line-height: 1.5;
            resize: vertical;
        }
        
        .progress-bar {
            width: 100%;
            height: 20px;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 10px;
            overflow: hidden;
            margin: 1rem 0;
        }
        
        .progress-fill {
            height: 100%;
            background: linear-gradient(45deg, #4facfe, #00f2fe);
            transition: width 0.3s ease;
        }
        
        .badge {
            display: inline-block;
            padding: 4px 8px;
            background: linear-gradient(45deg, #ffd700, #ffed4e);
            color: #333;
            border-radius: 15px;
            font-size: 0.8rem;
            font-weight: bold;
            margin: 2px;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 1rem;
            margin: 1rem 0;
        }
        
        .stat-card {
            text-align: center;
            padding: 1rem;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
        }
        
        .stat-number {
            font-size: 2rem;
            font-weight: bold;
            color: #ffd700;
        }
        
        .hidden {
            display: none !important;
        }
        
        .toast {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: rgba(0, 0, 0, 0.9);
            color: white;
            padding: 1rem 1.5rem;
            border-radius: 10px;
            z-index: 1500;
            animation: slideIn 0.3s ease;
        }
        
        @keyframes slideIn {
            from { transform: translateX(100%); }
            to { transform: translateX(0); }
        }
        
        .focus-meter {
            text-align: center;
            padding: 1rem;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            margin: 1rem 0;
        }
        
        .focus-indicator {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            margin: 0 auto 10px;
            transition: all 0.3s ease;
        }
        
        .focus-good { background: linear-gradient(45deg, #4CAF50, #8BC34A); }
        .focus-warning { background: linear-gradient(45deg, #FFC107, #FF9800); }
        .focus-danger { background: linear-gradient(45deg, #F44336, #FF5722); }
        
        .profile-info h3 {
            margin: 0 0 4px 0;
            font-size: 1.1rem;
            font-weight: 600;
        }
        
        .profile-info .username {
            margin: 0 0 4px 0;
            font-size: 0.9rem;
            color: #6366f1;
            font-weight: 500;
        }
        
        .profile-info .email {
            margin: 0;
            font-size: 0.9rem;
            color: #9ca3af;
        }
        
        .user-name {
            font-weight: 600;
            margin-bottom: 2px;
        }
        
        .user-username {
            font-size: 0.8rem;
            color: #6366f1;
            margin-bottom: 2px;
        }
        
        .user-stats {
            font-size: 0.8rem;
            color: #9ca3af;
        }
    </style>
      <!-- Favicon -->
  <link rel="icon" type="image/png" href="logo.png" />
</head>
<body>
    <!-- Header -->
    <div class="header">
        <div class="container">
            <h1>IT Survival Simulator</h1>
            <p class="tagline">Learn to code through practice ‚Äî not by copy-pasting!</p>
        </div>
    </div>

    <!-- Main Container -->
    <div class="container">
        <!-- Loading Screen -->
        <div id="loadingScreen" class="card">
            <div style="text-align: center;">
                <h2>Loading IT Survival Simulator...</h2>
                <p>Exciting challenges are being prepared for you!</p>
                <div class="progress-bar">
                    <div class="progress-fill" id="loadingProgress" style="width: 0%"></div>
                </div>
            </div>
        </div>

        <!-- Authentication Screen -->
        <div id="authScreen" class="hidden">
            <div class="card">
                <h2>Sign In or Create an Account</h2>
                <p>Embark on your IT survival journey!</p>
                
                <div id="loginForm">
                    <div class="input-group">
                        <label for="loginEmail">Email:</label>
                        <input type="email" id="loginEmail" placeholder="Enter your email">
                    </div>
                    <div class="input-group">
                        <label for="loginPassword">Password:</label>
                        <input type="password" id="loginPassword" placeholder="Enter your Password">
                    </div>
                    <button class="btn btn-primary" onclick="loginWithEmail()">Login</button>
                    <button class="btn btn-success" onclick="signupWithEmail()">Sign Up</button>
                    <button class="btn" onclick="loginWithGoogle()">Login with Google</button>
                </div>
                
                <div id="authMessage" style="margin-top: 1rem; text-align: center;"></div>
            </div>
        </div>

        <!-- Onboarding Screen -->
        <div id="onboardingScreen" class="hidden">
            <div class="card">
                <h2>Welcome to the IT Survival Simulator!</h2>
                <div id="onboardingContent">
                    <div class="onboarding-slide" id="slide1">
                        <h3>You can do it!</h3>
                        <p>Gain real-world IT skills through practical, hands-on experience.</p>
                        <p><strong>100 unique tasks</strong> designed to assess your knowledge in:</p>
                        <ul style="margin: 1rem 0;">
                            <li>üõ†Ô∏è Helpdesk & Technical Support</li>
                            <li>üíª Web Development</li>
                            <li>üêõ Debugging & Problem Solving</li>
                            <li>üåê Networking</li>
                            <li>üóÑÔ∏è Database Management</li>
                            <li>üîê Cybersecurity</li>
                            <li>‚öôÔ∏è DevOps & Deployment</li>
                            <li>üèõÔ∏è Government Systems (PH Context)</li>
                        </ul>
                    </div>
                    
                    <div class="onboarding-slide hidden" id="slide2">
                        <h3>Focus Enforcement Rules</h3>
                        <p><strong>Important:</strong> This platform is designed to encourage focused learning:</p>
                        <ul style="margin: 1rem 0;">
                            <li>üö´ <strong>Copy/Paste is disabled to ensure authentic learning.</strong> - Only manual typing is allowed</li>
                            <li>üö´ <strong>Tab switching ay monitored</strong> - Focus on the task</li>
                            <li>‚ö° <strong>Penalties:</strong> 1st = Warning, 2nd = Points deduction, 3rd = Task fail</li>
                            <li>üéØ <strong>Goal:</strong> Master problem-solving instead of relying on shortcuts.</li>
                        </ul>
                        <p><em>Note: Tab switching cannot be entirely blocked (because of browser restrictions), but our system detects and penalizes it to encourage effective learning practices.</em></p>
                    </div>
                    
                    <div class="onboarding-slide hidden" id="slide3">
                        <h3>Scoring & Badges System</h3>
                        <p>Earn rewards, points, and badges for every finished task:</p>
                        <ul style="margin: 1rem 0;">
                            <li>‚≠ê <strong>Easy Tasks:</strong> 50-100 points</li>
                            <li>‚≠ê‚≠ê <strong>Medium Tasks:</strong> 100-200 points</li>
                            <li>‚≠ê‚≠ê‚≠ê‚≠ê‚≠ê <strong>Hard Tasks:</strong> 200-500 points</li>
                            <li>üèÖ <strong>Special Badges:</strong> Streak bonuses, category mastery</li>
                            <li>üëë <strong>Leaderboard:</strong> Engage in friendly competition with your classmates</li>
                        </ul>
                    </div>
                </div>
                
                <div style="text-align: center; margin-top: 2rem;">
                    <button class="btn" id="prevSlide" onclick="changeSlide(-1)" disabled>Previous</button>
                    <button class="btn btn-primary" id="nextSlide" onclick="changeSlide(1)">Next</button>
                    <button class="btn btn-success hidden" id="startApp" onclick="completeOnboarding()">Start Learning!</button>
                </div>
            </div>
        </div>

        <!-- Main Dashboard -->
        <div id="dashboard" class="hidden">
            <div class="dashboard">
                <!-- Main Content -->
                <div class="main-content">
                    <!-- User Stats -->
                    <div class="card">
                        <h2>üëã Kumusta, <span id="userName">User</span>!</h2>
                        <div class="stats-grid">
                            <div class="stat-card">
                                <div class="stat-number" id="userPoints">0</div>
                                <div>Points</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-number" id="tasksCompleted">0</div>
                                <div>Tasks Done</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-number" id="currentStreak">0</div>
                                <div>Streak</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-number" id="focusPenalties">0</div>
                                <div>Penalties</div>
                            </div>
                        </div>
                    </div>

                    <!-- Task Filters -->
                    <div class="card">
                        <h3>Find Your Next Challenge</h3>
                        <div style="display: flex; gap: 1rem; margin: 1rem 0; flex-wrap: wrap;">
                            <select id="categoryFilter">
                                <option value="">All Categories</option>
                                <option value="helpdesk">Helpdesk</option>
                                <option value="webdev">Web Development</option>
                                <option value="debugging">Debugging</option>
                                <option value="networking">Networking</option>
                                <option value="database">Database</option>
                                <option value="security">Security</option>
                                <option value="devops">DevOps</option>
                                <option value="legacy">Legacy Systems</option>
                            </select>
                            <select id="difficultyFilter">
                                <option value="">All Difficulties</option>
                                <option value="1">‚≠ê Beginner</option>
                                <option value="2">‚≠ê‚≠ê Easy</option>
                                <option value="3">‚≠ê‚≠ê‚≠ê Medium</option>
                                <option value="4">‚≠ê‚≠ê‚≠ê‚≠ê Hard</option>
                                <option value="5">‚≠ê‚≠ê‚≠ê‚≠ê‚≠ê Expert</option>
                            </select>
                            <button class="btn" onclick="filterTasks()">Filter</button>
                            <button class="btn btn-primary" onclick="getRandomTask()">Random Task</button>
                        </div>
                    </div>

                    <!-- Tasks Grid -->
                    <div class="card">
                        <h3>Available Tasks</h3>
                        <div class="tasks-grid" id="tasksContainer">
                            <!-- Tasks will be loaded here -->
                        </div>
                    </div>
                </div>

                <!-- Sidebar -->
                <div class="sidebar">
                    <!-- Focus Meter -->
                    <div class="card">
                        <div class="focus-meter">
                            <div class="focus-indicator focus-good" id="focusIndicator"></div>
                            <h4>Focus Meter</h4>
                            <p id="focusStatus">Excellent Focus!</p>
                        </div>
                    </div>

                    <!-- Daily Mission -->
                    <!-- <div class="card">
                        <h4>Daily Mission</h4>
                        <p id="dailyMission">Complete 3 tasks today!</p>
                        <div class="progress-bar">
                            <div class="progress-fill" id="dailyProgress" style="width: 0%"></div>
                        </div>
                        <p id="dailyProgressText">0/3 completed</p>
                    </div> -->

                    <!-- Recent Badges -->
                    <div class="card">
                        <h4>Recent Badges</h4>
                        <div id="badgesContainer">
                            <span class="badge">Welcome!</span>
                        </div>
                    </div>

                    <!-- Leaderboard -->
                    <div class="card">
                        <h4>Top Performers</h4>
                        <div id="leaderboard">
                            <p>Loading leaderboard...</p>
                        </div>
                    </div>

                    <!-- User Actions -->
                    <div class="card">
                        <button class="btn btn-success" onclick="window.location.href='chat.html'" style="width: 100%; margin-bottom: 10px;">Public Chat</button>
                        <button class="btn btn-danger" onclick="logout()" style="width: 100%; margin-bottom: 10px;">Logout</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Task Modal -->
    <div id="taskModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeTaskModal()">&times;</span>
            <div id="taskContent">
                <!-- Task content will be loaded here -->
            </div>
        </div>
    </div>

    <!-- Profile Modal -->
    <div id="profileModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeProfileModal()">&times;</span>
            <h2>üë§ Your Profile</h2>
            <div id="profileContent">
                <!-- Profile content will be loaded here -->
            </div>
        </div>
    </div>

    <!-- Penalty Warning Overlay -->
    <div id="penaltyOverlay" class="penalty-warning hidden">
        <h3>Focus Violation Detected!</h3>
        <p id="penaltyMessage">Violation detected. Refocus on your work!</p>
        <button class="btn btn-primary" onclick="closePenaltyOverlay()">I Understand</button>
    </div>

    <!-- Return Warning (after tab switch) -->
    <div id="returnWarning" class="penalty-warning hidden">
        <h3>Welcome Back!</h3>
        <p>Tab change detected. Penalty given. Remain focused on the task!</p>
        <div id="returnCountdown">5</div>
        <p>Returning to task in <span id="returnTimer">5</span> seconds...</p>
    </div>

    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-storage-compat.js"></script>

    <script>
        // ===========================
        // FIREBASE CONFIGURATION
        // ===========================
        const firebaseConfig = {
            apiKey: "AIzaSyDDMZ08dDkvQVZYJjnup6BoyHlcK9pyICI",
            authDomain: "survivalit-d6575.firebaseapp.com",
            projectId: "survivalit-d6575",
            storageBucket: "survivalit-d6575.firebasestorage.app",
            messagingSenderId: "1008093127074",
            appId: "1:1008093127074:web:1be543615fef82286e52fb",
            measurementId: "G-QXRS2YL3VX"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const firestore = firebase.firestore();
        const storage = firebase.storage();

        // Configure Google Auth Provider
        const googleProvider = new firebase.auth.GoogleAuthProvider();

        // ===========================
        // GLOBAL VARIABLES
        // ===========================
        let currentUser = null;
        let currentTask = null;
        let taskTimer = null;
        let taskStartTime = null;
        let focusViolations = 0;
        let isTaskActive = false;
        let onboardingSlide = 1;
        let allTasks = [];
        let userProgress = {};

        // ===========================
        // CONSTANTS & CONFIGURATION
        // ===========================
        const PENALTY_CONFIG = {
            FIRST_VIOLATION: { pointsDeduction: 0.05, message: "First warning! Please concentrate on your work." },
            SECOND_VIOLATION: { pointsDeduction: 0.25, message: "Second strike! You‚Äôve received a large points penalty." },
            THIRD_VIOLATION: { message: "You have failed the task ‚Äî too many violations detected!" }
        };

        const TASK_CATEGORIES = {
            'helpdesk': 'Helpdesk',
            'webdev': 'Web Development', 
            'debugging': 'Debugging',
            'networking': 'Networking',
            'database': 'Database',
            'security': 'Security',
            'devops': 'DevOps',
            'legacy': 'Legacy Systems'
        };

        // ===========================
        // INITIALIZATION
        // ===========================
        document.addEventListener('DOMContentLoaded', function() {
            initializeApp();
            setupAntiCheatListeners();
        });

        async function initializeApp() {
            showLoadingScreen();
            
            // Simulate loading with progress
            let progress = 0;
            const progressInterval = setInterval(() => {
                progress += Math.random() * 15;
                if (progress > 90) progress = 90;
                document.getElementById('loadingProgress').style.width = progress + '%';
            }, 200);

            try {
                // Wait for auth state
                await new Promise((resolve) => {
                    const unsubscribe = auth.onAuthStateChanged((user) => {
                        unsubscribe();
                        resolve(user);
                    });
                });

                // Complete loading
                clearInterval(progressInterval);
                document.getElementById('loadingProgress').style.width = '100%';
                
                setTimeout(() => {
                    hideLoadingScreen();
                    checkAuthState();
                }, 1000);

            } catch (error) {
                console.error('Initialization error:', error);
                showToast('Error loading app: ' + error.message);
                clearInterval(progressInterval);
                hideLoadingScreen();
            }
        }

        function checkAuthState() {
            auth.onAuthStateChanged(async (user) => {
                if (user) {
                    currentUser = user;
                    await initializeUserData();
                    
                    // Check if user needs onboarding
                    const hasCompletedOnboarding = localStorage.getItem('completedOnboarding_' + user.uid);
                    if (!hasCompletedOnboarding) {
                        showOnboarding();
                    } else {
                        showDashboard();
                    }
                } else {
                    showAuthScreen();
                }
            });
        }

        // ===========================
        // SCREEN MANAGEMENT
        // ===========================
        function showLoadingScreen() {
            hideAllScreens();
            document.getElementById('loadingScreen').classList.remove('hidden');
        }

        function hideLoadingScreen() {
            document.getElementById('loadingScreen').classList.add('hidden');
        }

        function showAuthScreen() {
            hideAllScreens();
            document.getElementById('authScreen').classList.remove('hidden');
        }

        function showOnboarding() {
            hideAllScreens();
            document.getElementById('onboardingScreen').classList.remove('hidden');
        }

        function showDashboard() {
            hideAllScreens();
            document.getElementById('dashboard').classList.remove('hidden');
            loadDashboardData();
        }

        function hideAllScreens() {
            document.getElementById('loadingScreen').classList.add('hidden');
            document.getElementById('authScreen').classList.add('hidden');
            document.getElementById('onboardingScreen').classList.add('hidden');
            document.getElementById('dashboard').classList.add('hidden');
        }

        // ===========================
        // AUTHENTICATION FUNCTIONS
        // ===========================
        async function loginWithEmail() {
            const email = document.getElementById('loginEmail').value;
            const password = document.getElementById('loginPassword').value;
            
            if (!email || !password) {
                showAuthMessage('Please enter email and password', 'error');
                return;
            }

            try {
                await auth.signInWithEmailAndPassword(email, password);
                showAuthMessage('Login successful! üéâ', 'success');
            } catch (error) {
                showAuthMessage('Login failed: ' + error.message, 'error');
            }
        }

        async function signupWithEmail() {
            const email = document.getElementById('loginEmail').value;
            const password = document.getElementById('loginPassword').value;
            
            if (!email || !password) {
                showAuthMessage('Please enter email and password', 'error');
                return;
            }

            if (password.length < 6) {
                showAuthMessage('Password should be at least 6 characters', 'error');
                return;
            }

            try {
                const userCredential = await auth.createUserWithEmailAndPassword(email, password);
                await userCredential.user.updateProfile({
                    displayName: email.split('@')[0]
                });
                showAuthMessage('Account created successfully! üéâ', 'success');
            } catch (error) {
                showAuthMessage('Signup failed: ' + error.message, 'error');
            }
        }

        async function loginWithGoogle() {
            try {
                await auth.signInWithPopup(googleProvider);
                showAuthMessage('Google login successful! üéâ', 'success');
            } catch (error) {
                showAuthMessage('Google login failed: ' + error.message, 'error');
            }
        }

        async function logout() {
            try {
                await auth.signOut();
                showToast('Logged out successfully');
            } catch (error) {
                showToast('Logout failed: ' + error.message);
            }
        }

        function showAuthMessage(message, type) {
            const messageEl = document.getElementById('authMessage');
            messageEl.textContent = message;
            messageEl.style.color = type === 'error' ? '#ff6b6b' : '#4CAF50';
        }

        // ===========================
        // USER DATA MANAGEMENT
        // ===========================
        async function initializeUserData() {
            try {
                const userDoc = await firestore.collection('users').doc(currentUser.uid).get();
                
                if (!userDoc.exists) {
                    // Create new user document
                    await firestore.collection('users').doc(currentUser.uid).set({
                        displayName: currentUser.displayName || currentUser.email.split('@')[0],
                        email: currentUser.email,
                        photoURL: currentUser.photoURL || '',
                        points: 0,
                        tasksCompleted: 0,
                        focusPenalties: 0,
                        lastActive: firebase.firestore.FieldValue.serverTimestamp(),
                        createdAt: firebase.firestore.FieldValue.serverTimestamp()
                    });
                } else {
                    // Update last active
                    await firestore.collection('users').doc(currentUser.uid).update({
                        lastActive: firebase.firestore.FieldValue.serverTimestamp()
                    });
                }

                // Load user progress
                await loadUserProgress();
                
                // Initialize tasks if empty
                await initializeTasks();
                
            } catch (error) {
                console.error('Error initializing user data:', error);
                showToast('Error loading user data');
            }
        }

        async function loadUserProgress() {
            try {
                const progressSnapshot = await firestore.collection('userProgress')
                    .where('uid', '==', currentUser.uid)
                    .get();
                    
                userProgress = {};
                progressSnapshot.docs.forEach(doc => {
                    const data = doc.data();
                    userProgress[data.taskId] = data;
                });
                
            } catch (error) {
                console.error('Error loading user progress:', error);
            }
        }

        // ===========================
        // ONBOARDING FUNCTIONS
        // ===========================
        function changeSlide(direction) {
            const currentSlideEl = document.getElementById(`slide${onboardingSlide}`);
            currentSlideEl.classList.add('hidden');
            
            onboardingSlide += direction;
            
            const newSlideEl = document.getElementById(`slide${onboardingSlide}`);
            newSlideEl.classList.remove('hidden');
            
            // Update navigation buttons
            document.getElementById('prevSlide').disabled = onboardingSlide === 1;
            
            if (onboardingSlide === 3) {
                document.getElementById('nextSlide').classList.add('hidden');
                document.getElementById('startApp').classList.remove('hidden');
            } else {
                document.getElementById('nextSlide').classList.remove('hidden');
                document.getElementById('startApp').classList.add('hidden');
            }
        }

        function completeOnboarding() {
            localStorage.setItem('completedOnboarding_' + currentUser.uid, 'true');
            showDashboard();
        }

        // ===========================
        // DASHBOARD FUNCTIONS
        // ===========================
        async function loadDashboardData() {
            try {
                // Update user stats
                const userDoc = await firestore.collection('users').doc(currentUser.uid).get();
                const userData = userDoc.data();
                
                document.getElementById('userName').textContent = userData.displayName;
                document.getElementById('userPoints').textContent = userData.points || 0;
                document.getElementById('tasksCompleted').textContent = userData.tasksCompleted || 0;
                document.getElementById('focusPenalties').textContent = userData.focusPenalties || 0;
                
                // Update focus indicator
                updateFocusIndicator(userData.focusPenalties || 0);
                
                // Load tasks
                await loadTasks();
                
                // Load leaderboard
                await loadLeaderboard();
                
            } catch (error) {
                console.error('Error loading dashboard data:', error);
                showToast('Error loading dashboard data');
            }
        }

        async function loadTasks() {
            try {
                const tasksSnapshot = await firestore.collection('tasks').get();
                allTasks = tasksSnapshot.docs.map(doc => ({
                    id: doc.id,
                    ...doc.data()
                }));
                
                displayTasks(allTasks);
                
            } catch (error) {
                console.error('Error loading tasks:', error);
                showToast('Error loading tasks');
            }
        }

        function displayTasks(tasks) {
            const container = document.getElementById('tasksContainer');
            
            if (tasks.length === 0) {
                container.innerHTML = '<p>No tasks found. Try adjusting your filters.</p>';
                return;
            }
            
            container.innerHTML = tasks.map(task => {
                const isCompleted = userProgress[task.id]?.completed || false;
                const difficulty = '‚≠ê'.repeat(task.difficulty);
                
                return `
                    <div class="task-card ${isCompleted ? 'completed' : ''}" onclick="openTask('${task.id}')">
                        <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 10px;">
                            <span class="category category-${task.category}">${TASK_CATEGORIES[task.category]}</span>
                            <span class="difficulty difficulty-${task.difficulty}">${difficulty}</span>
                        </div>
                        <h4>${task.title}</h4>
                        <p style="opacity: 0.8; margin: 10px 0;">${task.description.substring(0, 100)}...</p>
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-top: 15px;">
                            <span>‚è±Ô∏è ${Math.floor(task.timeLimitSeconds / 60)}min</span>
                            ${isCompleted ? '<span style="color: #4CAF50;">Completed</span>' : ''}
                        </div>
                    </div>
                `;
            }).join('');
        }

        function filterTasks() {
            const category = document.getElementById('categoryFilter').value;
            const difficulty = document.getElementById('difficultyFilter').value;
            
            let filteredTasks = allTasks;
            
            if (category) {
                filteredTasks = filteredTasks.filter(task => task.category === category);
            }
            
            if (difficulty) {
                filteredTasks = filteredTasks.filter(task => task.difficulty === parseInt(difficulty));
            }
            
            displayTasks(filteredTasks);
        }

        function getRandomTask() {
            const availableTasks = allTasks.filter(task => !userProgress[task.id]?.completed);
            if (availableTasks.length === 0) {
                showToast('Congratulations! You\'ve completed all tasks!');
                return;
            }
            
            const randomTask = availableTasks[Math.floor(Math.random() * availableTasks.length)];
            openTask(randomTask.id);
        }

        async function loadLeaderboard() {
            try {
                const usersSnapshot = await firestore.collection('users')
                    .orderBy('points', 'desc')
                    .limit(5)
                    .get();
                
                const leaderboardEl = document.getElementById('leaderboard');
                leaderboardEl.innerHTML = usersSnapshot.docs.map((doc, index) => {
                    const user = doc.data();
                    const rank = index + 1;
                    const emoji = rank === 1 ? 'üëë' : rank === 2 ? 'ü•à' : rank === 3 ? 'ü•â' : 'üèÖ';
                    
                    return `
                        <div class="leaderboard-item ${user.uid === currentUser?.uid ? 'current-user' : ''}">
                            <span class="rank">#${index + 1}</span>
                            <img src="${user.photoURL || 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNDAiIGhlaWdodD0iNDAiIHZpZXdCb3g9IjAgMCA0MCA0MCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPGNpcmNsZSBjeD0iMjAiIGN5PSIyMCIgcj0iMjAiIGZpbGw9IiM2MzY2RjEiLz4KPHN2ZyB4PSI4IiB5PSI4IiB3aWR0aD0iMjQiIGhlaWdodD0iMjQiIHZpZXdCb3g9IjAgMCAyNCAyNCIgZmlsbD0ibm9uZSI+CjxwYXRoIGQ9Ik0yMCAyMXYtMmE0IDQgMCAwIDAtNC00SDhhNCA0IDAgMCAwLTQgNHYyIiBzdHJva2U9IndoaXRlIiBzdHJva2Utd2lkdGg9IjIiIHN0cm9rZS1saW5lY2FwPSJyb3VuZCIgc3Ryb2tlLWxpbmVqb2luPSJyb3VuZCIvPgo8Y2lyY2xlIGN4PSIxMiIgY3k9IjciIHI9IjQiIHN0cm9rZT0id2hpdGUiIHN0cm9rZS13aWR0aD0iMiIgc3Ryb2tlLWxpbmVjYXA9InJvdW5kIiBzdHJva2UtbGluZWpvaW49InJvdW5kIi8+Cjwvc3ZnPgo8L3N2Zz4K'}" alt="${user.displayName}">
                            <div class="user-info">
                                <div class="user-name">${user.displayName}</div>
                                <div class="user-username">@${user.username || user.displayName}</div>
                                <div class="user-stats">${user.tasksCompleted || 0} tasks completed</div>
                            </div>
                            <div class="user-points">${user.points || 0} pts</div>
                        </div>
                    `;
                }).join('');
                
            } catch (error) {
                console.error('Error loading leaderboard:', error);
                document.getElementById('leaderboard').innerHTML = '<p>Error loading leaderboard</p>';
            }
        }

        function updateFocusIndicator(penalties) {
            const indicator = document.getElementById('focusIndicator');
            const status = document.getElementById('focusStatus');
            
            if (penalties === 0) {
                indicator.className = 'focus-indicator focus-good';
                status.textContent = 'Excellent concentration!';
            } else if (penalties <= 3) {
                indicator.className = 'focus-indicator focus-warning';
                status.textContent = `${penalties} violations - Maintain your focus!`;
            } else {
                indicator.className = 'focus-indicator focus-danger';
                status.textContent = `${penalties} violations - Areas for Improvement Identified`;
            }
        }

        // ===========================
        // TASK MANAGEMENT
        // ===========================
        async function openTask(taskId) {
            try {
                const taskDoc = await firestore.collection('tasks').doc(taskId).get();
                
                if (!taskDoc.exists) {
                    showToast('Task not found');
                    return;
                }
                
                currentTask = { id: taskId, ...taskDoc.data() };
                displayTaskModal();
                
            } catch (error) {
                console.error('Error opening task:', error);
                showToast('Error opening task');
            }
        }

        function displayTaskModal() {
            const modal = document.getElementById('taskModal');
            const content = document.getElementById('taskContent');
            
            const isCompleted = userProgress[currentTask.id]?.completed || false;
            const difficulty = '‚≠ê'.repeat(currentTask.difficulty);
            
            content.innerHTML = `
                <h2>${currentTask.title}</h2>
                <div style="margin: 1rem 0;">
                    <span class="category category-${currentTask.category}">${TASK_CATEGORIES[currentTask.category]}</span>
                    <span class="difficulty difficulty-${currentTask.difficulty}">${difficulty}</span>
                    <span style="margin-left: 10px;">üéØ ${currentTask.points} points</span>
                    ${isCompleted ? '<span style="margin-left: 10px; color: #4CAF50;">Completed</span>' : ''}
                </div>
                
                <div class="card">
                    <h4>Task Description:</h4>
                    <p>${currentTask.description}</p>
                    
                    ${currentTask.inputSpec ? `
                        <h4>Input/Requirements:</h4>
                        <p>${currentTask.inputSpec}</p>
                    ` : ''}
                    
                    ${currentTask.expectedBehavior ? `
                        <h4>Expected Output:</h4>
                        <p>${currentTask.expectedBehavior}</p>
                    ` : ''}
                    
                    ${currentTask.hints ? `
                        <h4>Hints:</h4>
                        <p style="opacity: 0.8;">${currentTask.hints}</p>
                    ` : ''}
                </div>
                
                ${!isCompleted ? `
                    <div class="card">
                        <h4>Focus Rules Reminder:</h4>
                        <ul>
                            <li>Copying and pasting is prohibited.</li>
                            <li>Remain on this tab ‚Äî switching is penalized.</li>
                            <li>Complete within ${Math.floor(currentTask.timeLimitSeconds / 60)} minutes</li>
                            <li>Manual typing required for learning</li>
                        </ul>
                    </div>
                    
                    <div class="timer" id="taskTimer" style="display: none;">
                        Time Remaining: <span id="timeRemaining">--:--</span>
                    </div>
                    
                    <div class="card" id="taskInterface" style="display: none;">
                        <h4>Your Solution:</h4>
                        ${currentTask.taskType === 'code' ? `
                            <textarea class="code-editor" id="codeAnswer" placeholder="Type your code here... (No copy/paste allowed!)"></textarea>
                        ` : `
                            <textarea id="textAnswer" placeholder="Type your answer here... Minimum 50 characters required." style="width: 100%; height: 120px; padding: 10px; border-radius: 8px; border: 2px solid rgba(255,255,255,0.3); background: rgba(255,255,255,0.1); color: white;"></textarea>
                        `}
                        
                        <div style="margin-top: 1rem; text-align: center;">
                            <button class="btn btn-success" onclick="submitTask()">üöÄ Submit Solution</button>
                            <button class="btn" onclick="requestHint()">Request Hint (-10 pts)</button>
                        </div>
                    </div>
                    
                    <div style="text-align: center; margin-top: 2rem;">
                        <button class="btn btn-primary" onclick="startTask()" id="startTaskBtn">Start Task</button>
                    </div>
                ` : `
                    <div class="card">
                        <h3 style="color: #4CAF50; text-align: center;">Task Completed!</h3>
                        <p style="text-align: center;">You've already completed this task.</p>
                        ${userProgress[currentTask.id] ? `
                            <p><strong>Score:</strong> ${userProgress[currentTask.id].score} points</p>
                            <p><strong>Completed:</strong> ${new Date(userProgress[currentTask.id].completedAt.seconds * 1000).toLocaleString()}</p>
                        ` : ''}
                    </div>
                `}
            `;
            
            modal.style.display = 'block';
        }

        function startTask() {
            if (isTaskActive) {
                showToast('Task already active!');
                return;
            }
            
            isTaskActive = true;
            focusViolations = 0;
            taskStartTime = Date.now();
            
            // Show task interface
            document.getElementById('taskInterface').style.display = 'block';
            document.getElementById('taskTimer').style.display = 'block';
            document.getElementById('startTaskBtn').style.display = 'none';
            
            // Start timer
            startTaskTimer();
            
            // Show focus warning
            showToast('‚ö° Task started! Focus mode activated. No tab switching or copy/paste!');
            
            // Enable enhanced monitoring
            enableTaskMonitoring();
        }

        function startTaskTimer() {
            const timeLimit = currentTask.timeLimitSeconds;
            let timeRemaining = timeLimit;
            
            taskTimer = setInterval(() => {
                timeRemaining--;
                
                const minutes = Math.floor(timeRemaining / 60);
                const seconds = timeRemaining % 60;
                document.getElementById('timeRemaining').textContent = 
                    `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
                
                if (timeRemaining <= 0) {
                    clearInterval(taskTimer);
                    showToast('‚è∞ Time up! Task failed due to timeout.');
                    endTask(false);
                }
            }, 1000);
        }

        function enableTaskMonitoring() {
            // This will be handled by the global anti-cheat listeners
            // Just set flag that task is active
            document.body.setAttribute('data-task-active', 'true');
        }

        function disableTaskMonitoring() {
            document.body.removeAttribute('data-task-active');
        }

        async function submitTask() {
            if (!isTaskActive) {
                showToast('No active task to submit');
                return;
            }
            
            const answer = currentTask.taskType === 'code' 
                ? document.getElementById('codeAnswer').value.trim()
                : document.getElementById('textAnswer').value.trim();
            
            if (!answer) {
                showToast('Please provide an answer before submitting');
                return;
            }
            
            if (currentTask.taskType !== 'code' && answer.length < 50) {
                showToast('Answer too short. Please provide at least 50 characters.');
                return;
            }
            
            try {
                // Stop timer
                clearInterval(taskTimer);
                
                // Enhanced validation based on task content and keywords
                const validationResult = validateTaskAnswer(currentTask, answer);
                const isCorrect = validationResult.isCorrect;

                // Calculate score
                const score = calculateTaskScore(answer, {
                    score: validationResult.score,
                    feedback: validationResult.feedback
                });
                
                // Save progress
                await saveTaskProgress(score, answer);
                
                // Update user stats
                await updateUserStats(score);
                
                // End task
                endTask(true, score);
                
            } catch (error) {
                console.error('Error submitting task:', error);
                showToast('Error submitting task: ' + error.message);
            }
        }

        function validateTaskAnswer(task, answer) {
            const answerLower = answer.toLowerCase();
            let score = 0;
            let feedback = '';
            let isCorrect = false;
            
            // Define required keywords and concepts for different task categories
            const validationRules = {
                'css-overflow': {
                    required: ['overflow', 'hidden', 'scroll', 'auto'],
                    optional: ['visible', 'clip', 'ellipsis'],
                    concepts: ['css property', 'content clipping', 'scrollbar']
                },
                'sql-injection': {
                    required: ['sql injection', 'prepared statement', 'parameterized', 'sanitize'],
                    optional: ['escape', 'validation', 'whitelist', 'stored procedure'],
                    concepts: ['security vulnerability', 'database attack', 'prevention']
                },
                'network-troubleshoot': {
                    required: ['ping', 'traceroute', 'dns', 'ip'],
                    optional: ['nslookup', 'netstat', 'route', 'gateway'],
                    concepts: ['network connectivity', 'troubleshooting steps', 'diagnostic tools']
                },
                'password-policy': {
                    required: ['password', 'complexity', 'length', 'character'],
                    optional: ['uppercase', 'lowercase', 'number', 'special', 'symbol'],
                    concepts: ['security policy', 'authentication', 'strong password']
                },
                'backup-strategy': {
                    required: ['backup', 'restore', 'schedule', 'storage'],
                    optional: ['incremental', 'full', 'differential', 'cloud'],
                    concepts: ['data protection', 'disaster recovery', 'backup types']
                }
            };
            
            // Get validation rule based on task title/content
            let rule = null;
            const taskTitle = task.title.toLowerCase();
            
            if (taskTitle.includes('overflow') || taskTitle.includes('css')) {
                rule = validationRules['css-overflow'];
            } else if (taskTitle.includes('sql') || taskTitle.includes('injection')) {
                rule = validationRules['sql-injection'];
            } else if (taskTitle.includes('network') || taskTitle.includes('troubleshoot')) {
                rule = validationRules['network-troubleshoot'];
            } else if (taskTitle.includes('password') || taskTitle.includes('policy')) {
                rule = validationRules['password-policy'];
            } else if (taskTitle.includes('backup') || taskTitle.includes('strategy')) {
                rule = validationRules['backup-strategy'];
            }
            
            if (rule) {
                // Check required keywords
                let requiredFound = 0;
                let optionalFound = 0;
                
                rule.required.forEach(keyword => {
                    if (answerLower.includes(keyword)) {
                        requiredFound++;
                        score += 20;
                    }
                });
                
                rule.optional.forEach(keyword => {
                    if (answerLower.includes(keyword)) {
                        optionalFound++;
                        score += 10;
                    }
                });
                
                // Check for concept understanding
                let conceptsFound = 0;
                rule.concepts.forEach(concept => {
                    if (answerLower.includes(concept.toLowerCase())) {
                        conceptsFound++;
                        score += 15;
                    }
                });
                
                // Determine if answer is correct
                const requiredPercentage = requiredFound / rule.required.length;
                
                if (requiredPercentage >= 0.6 && score >= 60) {
                    isCorrect = true;
                    feedback = `Excellent! You demonstrated good understanding with ${requiredFound}/${rule.required.length} key concepts.`;
                } else if (requiredPercentage >= 0.4 && score >= 40) {
                    isCorrect = false;
                    score = Math.floor(score * 0.5); // Partial credit
                    feedback = `Partial credit. You covered some concepts but missed key requirements. Try to include: ${rule.required.filter(req => !answerLower.includes(req)).join(', ')}`;
                } else {
                    isCorrect = false;
                    score = 0;
                    feedback = `Incorrect. Your answer doesn't demonstrate understanding of the key concepts. Required topics: ${rule.required.join(', ')}`;
                }
            } else {
                // Generic validation for tasks without specific rules
                const wordCount = answer.split(/\s+/).length;
                const hasVariedVocabulary = new Set(answerLower.split(/\s+/)).size > wordCount * 0.7;
                const hasProperStructure = answer.includes('.') || answer.includes('?') || answer.includes('!');
                
                if (wordCount >= 20 && hasVariedVocabulary && hasProperStructure) {
                    isCorrect = true;
                    score = task.points;
                    feedback = 'Good answer with proper structure and content.';
                } else {
                    isCorrect = false;
                    score = 0;
                    feedback = 'Answer lacks depth, structure, or relevant content. Please provide a more detailed and thoughtful response.';
                }
            }
            
            return {
                isCorrect: isCorrect,
                score: Math.min(score, task.points), // Cap at max task points
                feedback: feedback
            };
        }

        function calculateTaskScore(answer, validationResult) {
            let baseScore = validationResult ? validationResult.score : currentTask.points;
            
            // Apply focus penalties
            if (focusViolations > 0) {
                if (focusViolations === 1) {
                    baseScore *= (1 - PENALTY_CONFIG.FIRST_VIOLATION.pointsDeduction);
                } else if (focusViolations === 2) {
                    baseScore *= (1 - PENALTY_CONFIG.SECOND_VIOLATION.pointsDeduction);
                } else {
                    return 0; // Task failed due to excessive violations
                }
            }
            
            // Time bonus (if completed in less than 50% of time limit)
            const timeUsed = (Date.now() - taskStartTime) / 1000;
            const timeLimit = currentTask.timeLimitSeconds;
            if (timeUsed < timeLimit * 0.5) {
                baseScore *= 1.2; // 20% time bonus
            }
            
            // Basic answer quality check
            if (currentTask.taskType === 'code') {
                // Simple code quality heuristics
                if (answer.includes('function') || answer.includes('const') || answer.includes('let')) {
                    // Looks like proper code structure
                    baseScore *= 1.0;
                } else {
                    // Might be low quality
                    baseScore *= 0.8;
                }
            } else {
                // Text answer quality based on length and keywords
                if (answer.length > 200) {
                    baseScore *= 1.1; // Bonus for detailed answers
                }
            }
            
            return Math.floor(baseScore);
        }

        async function saveTaskProgress(score, answer) {
            const progressData = {
                uid: currentUser.uid,
                taskId: currentTask.id,
                completed: true,
                score: score,
                answer: answer,
                timeSpent: Math.floor((Date.now() - taskStartTime) / 1000),
                focusViolations: focusViolations,
                completedAt: firebase.firestore.FieldValue.serverTimestamp()
            };
            
            await firestore.collection('userProgress').add(progressData);
            userProgress[currentTask.id] = progressData;
        }

        async function updateUserStats(score) {
            const userRef = firestore.collection('users').doc(currentUser.uid);
            const userDoc = await userRef.get();
            const userData = userDoc.data();
            
            await userRef.update({
                points: (userData.points || 0) + score,
                tasksCompleted: (userData.tasksCompleted || 0) + 1,
                focusPenalties: (userData.focusPenalties || 0) + focusViolations,
                lastActive: firebase.firestore.FieldValue.serverTimestamp()
            });
        }

        function endTask(success, score = 0) {
            isTaskActive = false;
            clearInterval(taskTimer);
            disableTaskMonitoring();
            
            // Show results
            const resultMessage = success 
                ? `üéâ Task completed! You earned ${score} points!`
                : `‚ùå Task failed. Better luck next time!`;
            
            showToast(resultMessage);
            
            // Close modal and refresh dashboard
            closeTaskModal();
            setTimeout(() => {
                loadDashboardData();
            }, 1000);
        }

        function requestHint() {
            // Deduct 10 points for hint
            showToast('üí° Hint requested! 10 points deducted.');
            // You could implement hint revealing logic here
        }

        function closeTaskModal() {
            document.getElementById('taskModal').style.display = 'none';
            if (isTaskActive) {
                clearInterval(taskTimer);
                isTaskActive = false;
                disableTaskMonitoring();
            }
        }

        // ===========================
        // ANTI-CHEAT & FOCUS ENFORCEMENT
        // ===========================
        function setupAntiCheatListeners() {
            // Page Visibility API - detect tab switching
            document.addEventListener('visibilitychange', handleVisibilityChange);
            
            // Window focus/blur
            window.addEventListener('blur', handleWindowBlur);
            window.addEventListener('focus', handleWindowFocus);
            
            // Copy/paste prevention
            document.addEventListener('copy', preventCopy);
            document.addEventListener('cut', preventCut);
            document.addEventListener('paste', preventPaste);
            document.addEventListener('contextmenu', preventContextMenu);
            
            // Keyboard shortcuts prevention
            document.addEventListener('keydown', preventShortcuts);
            
            // Before unload warning
            window.addEventListener('beforeunload', handleBeforeUnload);
            
            // Selection prevention during tasks
            document.addEventListener('selectstart', preventSelection);
        }

        function handleVisibilityChange() {
            if (document.hidden && isTaskActive) {
                registerFocusViolation('Tab switch detected');
            } else if (!document.hidden && isTaskActive) {
                showReturnWarning();
            }
        }

        function handleWindowBlur() {
            if (isTaskActive) {
                registerFocusViolation('Window lost focus');
            }
        }

        function handleWindowFocus() {
            if (isTaskActive && focusViolations > 0) {
                showReturnWarning();
            }
        }

        function preventCopy(e) {
            if (isTaskActive) {
                e.preventDefault();
                registerFocusViolation('Copy attempt detected');
                return false;
            }
        }

        function preventCut(e) {
            if (isTaskActive) {
                e.preventDefault();
                registerFocusViolation('Cut attempt detected');
                return false;
            }
        }

        function preventPaste(e) {
            if (isTaskActive) {
                e.preventDefault();
                registerFocusViolation('Paste attempt detected');
                return false;
            }
        }

        function preventContextMenu(e) {
            if (isTaskActive) {
                e.preventDefault();
                showToast('Right-click disabled during task');
                return false;
            }
        }

        function preventShortcuts(e) {
            if (isTaskActive) {
                const forbiddenKeys = [
                    'KeyC', 'KeyV', 'KeyX', 'KeyT', 'KeyW', 'KeyN'
                ];
                
                if ((e.ctrlKey || e.metaKey) && forbiddenKeys.includes(e.code)) {
                    e.preventDefault();
                    registerFocusViolation(`Keyboard shortcut blocked: ${e.code}`);
                    return false;
                }
            }
        }

        function preventSelection(e) {
            if (isTaskActive && !e.target.matches('input, textarea, #codeAnswer, #textAnswer')) {
                e.preventDefault();
                return false;
            }
        }

        function handleBeforeUnload(e) {
            if (isTaskActive) {
                const message = 'You have an active task. Are you sure you want to leave?';
                e.returnValue = message;
                return message;
            }
        }

        function registerFocusViolation(reason) {
            focusViolations++;
            
            // Log violation to Firestore
            logFocusViolation(reason);
            
            // Apply penalty based on violation count
            if (focusViolations === 1) {
                showPenaltyWarning(PENALTY_CONFIG.FIRST_VIOLATION.message);
            } else if (focusViolations === 2) {
                showPenaltyWarning(PENALTY_CONFIG.SECOND_VIOLATION.message);
            } else if (focusViolations >= 3) {
                showPenaltyWarning(PENALTY_CONFIG.THIRD_VIOLATION.message);
                setTimeout(() => {
                    endTask(false);
                }, 3000);
            }
        }

        async function logFocusViolation(reason) {
            try {
                await firestore.collection('focusLogs').add({
                    uid: currentUser.uid,
                    taskId: currentTask?.id || null,
                    reason: reason,
                    timestamp: firebase.firestore.FieldValue.serverTimestamp(),
                    violationCount: focusViolations
                });
            } catch (error) {
                console.error('Error logging focus violation:', error);
            }
        }

        function showPenaltyWarning(message) {
            const overlay = document.getElementById('penaltyOverlay');
            document.getElementById('penaltyMessage').textContent = message;
            overlay.classList.remove('hidden');
        }

        function closePenaltyOverlay() {
            document.getElementById('penaltyOverlay').classList.add('hidden');
        }

        function showReturnWarning() {
            const overlay = document.getElementById('returnWarning');
            overlay.classList.remove('hidden');
            
            let countdown = 5;
            const countdownEl = document.getElementById('returnTimer');
            
            const timer = setInterval(() => {
                countdown--;
                countdownEl.textContent = countdown;
                
                if (countdown <= 0) {
                    clearInterval(timer);
                    overlay.classList.add('hidden');
                }
            }, 1000);
        }

        // ===========================
        // TASK INITIALIZATION & SEEDING
        // ===========================
        async function initializeTasks() {
            try {
                const tasksSnapshot = await firestore.collection('tasks').limit(1).get();
                
                if (tasksSnapshot.empty) {
                    console.log('No tasks found. Seeding database...');
                    await seedTasks();
                }
            } catch (error) {
                console.error('Error checking tasks:', error);
            }
        }

        async function seedTasks() {
            const tasks = generateAllTasks();
            const batch = firestore.batch();
            
            tasks.forEach((task, index) => {
                const taskRef = firestore.collection('tasks').doc();
                batch.set(taskRef, task);
            });
            
            try {
                await batch.commit();
                console.log('Successfully seeded', tasks.length, 'tasks');
                showToast(`üöÄ Initialized ${tasks.length} tasks!`);
            } catch (error) {
                console.error('Error seeding tasks:', error);
                showToast('Error initializing tasks: ' + error.message);
            }
        }

        function generateAllTasks() {
            const baseTasks = [
                // Helpdesk Tasks
                {
                    title: "Printer Not Working - Diagnosis",
                    category: "helpdesk",
                    difficulty: 1,
                    timeLimitSeconds: 900,
                    description: "A user reports their printer isn't working. They can't print any documents from their computer. Walk through the diagnosis process.",
                    inputSpec: "User says 'My printer won't print anything. The power is on but nothing happens.'",
                    expectedBehavior: "Provide step-by-step troubleshooting guide",
                    points: 75,
                    hints: "Check physical connections, drivers, print queue, and network connectivity",
                    taskType: "text"
                },
                {
                    title: "Email Setup for New Employee",
                    category: "helpdesk", 
                    difficulty: 2,
                    timeLimitSeconds: 1200,
                    description: "Configure email settings for a new employee using Outlook. They need access to company email on their laptop and phone.",
                    inputSpec: "Employee details: Juan Dela Cruz, position: Accounting Assistant, email: j.delacruz@company.ph",
                    expectedBehavior: "Complete configuration steps for both devices",
                    points: 100,
                    hints: "Consider IMAP/POP3 settings, security, and mobile device management",
                    taskType: "text"
                },

                // Web Development Tasks  
                {
                    title: "Fix Barangay Website Header Overflow",
                    category: "webdev",
                    difficulty: 2,
                    timeLimitSeconds: 1800,
                    description: "The barangay website header is overflowing on mobile devices. Fix the CSS to make it responsive.",
                    inputSpec: "CSS for header has fixed width of 1200px and absolute positioning",
                    expectedBehavior: "Header should be responsive and work on all screen sizes",
                    points: 120,
                    hints: "Use flexbox or CSS Grid, media queries, and relative units",
                    taskType: "code"
                },
                {
                    title: "Create PHP Contact Form",
                    category: "webdev",
                    difficulty: 3,
                    timeLimitSeconds: 2400,
                    description: "Create a secure PHP contact form for a government website that validates input and prevents XSS.",
                    inputSpec: "Form needs: Name, Email, Message, Department dropdown",
                    expectedBehavior: "Secure form with validation and sanitization",
                    points: 180,
                    hints: "Use filter_var(), htmlspecialchars(), and prepared statements",
                    taskType: "code"
                },

                // Debugging Tasks
                {
                    title: "Debug Unicode String Reversal",
                    category: "debugging",
                    difficulty: 3,
                    timeLimitSeconds: 1500,
                    description: "This JavaScript function should reverse a string but fails with Unicode characters like emoji. Find and fix the bug.",
                    inputSpec: "function reverseString(str) { return str.split('').reverse().join(''); }",
                    expectedBehavior: "Function should properly reverse strings with Unicode characters",
                    points: 150,
                    hints: "Consider using Array.from() or spread operator for proper Unicode handling",
                    taskType: "code"
                },
                {
                    title: "Fix SQL Query Performance Issue",
                    category: "debugging",
                    difficulty: 4,
                    timeLimitSeconds: 2100,
                    description: "A query that joins residents and barangays is extremely slow. Optimize it for better performance.",
                    inputSpec: "SELECT * FROM residents r JOIN barangays b ON r.barangay_id = b.id WHERE b.city = 'Manila'",
                    expectedBehavior: "Optimized query with proper indexing suggestions",
                    points: 250,
                    hints: "Consider indexing, query structure, and unnecessary SELECT * usage",
                    taskType: "code"
                },

                // Database Tasks
                {
                    title: "Design School Management Database",
                    category: "database",
                    difficulty: 3,
                    timeLimitSeconds: 2400,
                    description: "Create a normalized database schema for a Philippine public school system including students, teachers, subjects, and grades.",
                    inputSpec: "Must track student enrollment, class schedules, grades, and teacher assignments",
                    expectedBehavior: "Proper 3NF normalized schema with relationships",
                    points: 200,
                    hints: "Consider many-to-many relationships and avoid data redundancy",
                    taskType: "code"
                },
                {
                    title: "SQL Join for Household Census",
                    category: "database",
                    difficulty: 2,
                    timeLimitSeconds: 1200,
                    description: "Write SQL to join residents and households tables to get household count per barangay.",
                    inputSpec: "Tables: residents(id, name, household_id), households(id, barangay_id), barangays(id, name)",
                    expectedBehavior: "Query showing barangay name and household count",
                    points: 130,
                    hints: "Use JOIN and GROUP BY with COUNT",
                    taskType: "code"
                },

                // Networking Tasks
                {
                    title: "Configure School LAN Network",
                    category: "networking", 
                    difficulty: 3,
                    timeLimitSeconds: 1800,
                    description: "Configure static IP and DNS settings for a school computer lab with 30 computers.",
                    inputSpec: "Network: 192.168.1.0/24, Gateway: 192.168.1.1, DNS: 8.8.8.8, 8.8.4.4",
                    expectedBehavior: "Complete network configuration plan with IP assignments",
                    points: 160,
                    hints: "Consider DHCP vs static, IP ranges, and network documentation",
                    taskType: "text"
                },
                {
                    title: "Troubleshoot Internet Connectivity",
                    category: "networking",
                    difficulty: 2,
                    timeLimitSeconds: 1200,
                    description: "Users in a government office can't access the internet. Diagnose the network connectivity issue.",
                    inputSpec: "Symptoms: Can ping local devices but not external websites. Local network seems fine.",
                    expectedBehavior: "Step-by-step network troubleshooting process",
                    points: 110,
                    hints: "Check DNS, gateway, firewall, and ISP connectivity",
                    taskType: "text"
                },

                // Security Tasks
                {
                    title: "Fix SQL Injection Vulnerability",
                    category: "security",
                    difficulty: 3,
                    timeLimitSeconds: 1500,
                    description: "This login form is vulnerable to SQL injection. Fix it using parameterized queries.",
                    inputSpec: "SELECT * FROM users WHERE username = '$username' AND password = '$password'",
                    expectedBehavior: "Secure query using prepared statements",
                    points: 170,
                    hints: "Use prepared statements or parameterized queries",
                    taskType: "code"
                },
                {
                    title: "Implement Password Hashing",
                    category: "security",
                    difficulty: 3,
                    timeLimitSeconds: 1800,
                    description: "Replace plain text password storage with secure hashing for a PHP application.",
                    inputSpec: "Current code stores passwords as plain text in database",
                    expectedBehavior: "Secure password hashing and verification system",
                    points: 180,
                    hints: "Use password_hash() and password_verify() functions",
                    taskType: "code"
                },

                // DevOps Tasks
                {
                    title: "Deploy Static Site to Firebase",
                    category: "devops",
                    difficulty: 2,
                    timeLimitSeconds: 1500,
                    description: "Create the commands needed to deploy a barangay website to Firebase Hosting.",
                    inputSpec: "Static HTML/CSS/JS website in /public folder",
                    expectedBehavior: "Complete deployment command sequence",
                    points: 140,
                    hints: "Use Firebase CLI: init, build, deploy commands",
                    taskType: "text"
                },
                {
                    title: "Setup Git Workflow",
                    category: "devops",
                    difficulty: 2,
                    timeLimitSeconds: 1200,
                    description: "Establish a Git workflow for a small development team working on a government portal.",
                    inputSpec: "Team of 3 developers, need feature branches and code review process",
                    expectedBehavior: "Complete Git workflow with branching strategy",
                    points: 120,
                    hints: "Consider Git Flow or GitHub Flow with pull requests",
                    taskType: "text"
                },

                // Legacy Systems
                {
                    title: "Migrate CSV Payroll to Database",
                    category: "legacy",
                    difficulty: 4,
                    timeLimitSeconds: 2700,
                    description: "Convert a CSV-based payroll system to a normalized database structure.",
                    inputSpec: "CSV contains: employee_name, position, department, salary, benefits, deductions",
                    expectedBehavior: "Normalized database schema and migration plan",
                    points: 280,
                    hints: "Separate entities: employees, positions, departments, payroll records",
                    taskType: "code"
                },
                {
                    title: "Modernize VB6 Application Logic",
                    category: "legacy",
                    difficulty: 5,
                    timeLimitSeconds: 3600,
                    description: "Convert this VB6 business logic to modern PHP or JavaScript for a government records system.",
                    inputSpec: "VB6 code for calculating employee benefits based on years of service and position",
                    expectedBehavior: "Modern equivalent code with same business logic",
                    points: 350,
                    hints: "Focus on business rules, not UI conversion",
                    taskType: "code"
                }
            ];

            // Generate variations to reach 100 tasks
            const allTasks = [...baseTasks];
            
            // Generate variations by modifying parameters
            const variations = [
                { suffix: " - Variant A", pointsMultiplier: 1.1, timeDelta: 300 },
                { suffix: " - Variant B", pointsMultiplier: 0.9, timeDelta: -300 },
                { suffix: " - Advanced", pointsMultiplier: 1.3, timeDelta: 600, difficultyDelta: 1 },
                { suffix: " - Quick Challenge", pointsMultiplier: 0.7, timeDelta: -600, difficultyDelta: -1 }
            ];
            
            // Create variations for each base task
            baseTasks.forEach(baseTask => {
                variations.forEach(variation => {
                    const newDifficulty = Math.max(1, Math.min(5, baseTask.difficulty + (variation.difficultyDelta || 0)));
                    const newTask = {
                        ...baseTask,
                        title: baseTask.title + variation.suffix,
                        difficulty: newDifficulty,
                        points: Math.floor(baseTask.points * variation.pointsMultiplier),
                        timeLimitSeconds: Math.max(300, baseTask.timeLimitSeconds + variation.timeDelta)
                    };
                    allTasks.push(newTask);
                });
            });

            // Add some additional unique tasks to reach 100
            const additionalTasks = [
                {
                    title: "Setup WordPress for Barangay",
                    category: "webdev",
                    difficulty: 2,
                    timeLimitSeconds: 2400,
                    description: "Install and configure WordPress for a barangay website with proper security settings.",
                    points: 150,
                    taskType: "text"
                },
                {
                    title: "Create Responsive Navigation",
                    category: "webdev", 
                    difficulty: 3,
                    timeLimitSeconds: 2100,
                    description: "Build a responsive navigation menu that works on mobile devices.",
                    points: 160,
                    taskType: "code"
                },
                {
                    title: "Implement Session Management",
                    category: "security",
                    difficulty: 4,
                    timeLimitSeconds: 2400,
                    description: "Create secure session management for a government portal login system.",
                    points: 220,
                    taskType: "code"
                },
                {
                    title: "Database Backup Strategy",
                    category: "database",
                    difficulty: 3,
                    timeLimitSeconds: 1800,
                    description: "Design a backup and recovery strategy for critical government databases.",
                    points: 180,
                    taskType: "text"
                },
                {
                    title: "API Rate Limiting",
                    category: "security",
                    difficulty: 4,
                    timeLimitSeconds: 2100,
                    description: "Implement rate limiting for a government API to prevent abuse.",
                    points: 240,
                    taskType: "code"
                }
            ];

            allTasks.push(...additionalTasks);

            // Ensure we have exactly 100 tasks
            return allTasks.slice(0, 100);
        }

        // ===========================
        // UTILITY FUNCTIONS
        // ===========================
        function showToast(message, duration = 3000) {
            const toast = document.createElement('div');
            toast.className = 'toast';
            toast.textContent = message;
            document.body.appendChild(toast);
            
            setTimeout(() => {
                if (document.body.contains(toast)) {
                    document.body.removeChild(toast);
                }
            }, duration);
        }

        function showProfile() {
            const modal = document.getElementById('profileModal');
            const content = document.getElementById('profileContent');
            
            content.innerHTML = `
                <div style="text-align: center; margin-bottom: 2rem;">
                    <div class="profile-info">
                        <img src="${currentUser.photoURL || 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNDAiIGhlaWdodD0iNDAiIHZpZXdCb3g9IjAgMCA0MCA0MCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPGNpcmNsZSBjeD0iMjAiIGN5PSIyMCIgcj0iMjAiIGZpbGw9IiM2MzY2RjEiLz4KPHN2ZyB4PSI4IiB5PSI4IiB3aWR0aD0iMjQiIGhlaWdodD0iMjQiIHZpZXdCb3g9IjAgMCAyNCAyNCIgZmlsbD0ibm9uZSI+CjxwYXRoIGQ9Ik0yMCAyMXYtMmE0IDQgMCAwIDAtNC00SDhhNCA0IDAgMCAwLTQgNHYyIiBzdHJva2U9IndoaXRlIiBzdHJva2Utd2lkdGg9IjIiIHN0cm9rZS1saW5lY2FwPSJyb3VuZCIgc3Ryb2tlLWxpbmVqb2luPSJyb3VuZCIvPgo8Y2lyY2xlIGN4PSIxMiIgY3k9IjciIHI9IjQiIHN0cm9rZT0id2hpdGUiIHN0cm9rZS13aWR0aD0iMiIgc3Ryb2tlLWxpbmVjYXA9InJvdW5kIiBzdHJva2UtbGluZWpvaW49InJvdW5kIi8+Cjwvc3ZnPgo8L3N2Zz4K'}" alt="Profile">
                        <div>
                            <h3>${userData.displayName}</h3>
                            <p class="username">@${userData.username || userData.displayName}</p>
                            <p class="email">${userData.email}</p>
                        </div>
                    </div>
                </div>
                
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-number" id="profilePoints">Loading...</div>
                        <div>Total Points</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="profileTasks">Loading...</div>
                        <div>Tasks Completed</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="profilePenalties">Loading...</div>
                        <div>Focus Penalties</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="profileRank">Loading...</div>
                        <div>Current Rank</div>
                    </div>
                </div>
                
                <div class="card">
                    <h4>üèÜ Achievements</h4>
                    <div id="achievementsList">Loading...</div>
                </div>
                
                <div class="card">
                    <h4>üìä Progress by Category</h4>
                    <div id="categoryProgress">Loading...</div>
                </div>
            `;
            
            modal.style.display = 'block';
            loadProfileData();
        }

        async function loadProfileData() {
            try {
                const userDoc = await firestore.collection('users').doc(currentUser.uid).get();
                const userData = userDoc.data();
                
                document.getElementById('profilePoints').textContent = userData.points || 0;
                document.getElementById('profileTasks').textContent = userData.tasksCompleted || 0;
                document.getElementById('profilePenalties').textContent = userData.focusPenalties || 0;
                
                // Calculate rank
                const rankSnapshot = await firestore.collection('users')
                    .where('points', '>', userData.points || 0)
                    .get();
                document.getElementById('profileRank').textContent = rankSnapshot.size + 1;
                
                // Load achievements
                const achievements = calculateAchievements(userData);
                document.getElementById('achievementsList').innerHTML = achievements.map(ach => 
                    `<span class="badge">${ach}</span>`
                ).join(' ');
                
            } catch (error) {
                console.error('Error loading profile data:', error);
            }
        }

        function calculateAchievements(userData) {
            const achievements = [];
            
            if (userData.tasksCompleted >= 1) achievements.push("üéØ First Task");
            if (userData.tasksCompleted >= 5) achievements.push("üî• Task Warrior");
            if (userData.tasksCompleted >= 25) achievements.push("üí™ Quarter Century");
            if (userData.tasksCompleted >= 50) achievements.push("üèÜ Half Century");
            if (userData.tasksCompleted >= 100) achievements.push("üëë Task Master");
            
            if (userData.points >= 1000) achievements.push("üí∞ Point Collector");
            if (userData.points >= 5000) achievements.push("üíé Point Master");
            
            if ((userData.focusPenalties || 0) === 0 && userData.tasksCompleted >= 10) {
                achievements.push("üéØ Perfect Focus");
            }
            
            return achievements;
        }

        function closeProfileModal() {
            document.getElementById('profileModal').style.display = 'none';
        }

        // ===========================
        // FOOTER ATTRIBUTION
        // ===========================
        document.body.insertAdjacentHTML('beforeend', `
            <footer style="text-align: center; padding: 2rem; margin-top: 3rem; border-top: 1px solid rgba(255,255,255,0.2);">
                <p style="opacity: 0.8;">Made with ‚ù§Ô∏è by Steven Macapa√±as</p>
            </footer>
        `);
        
        // Initialize on load
        document.addEventListener('DOMContentLoaded', initializeApp);
    </script>
</body>
</html>

